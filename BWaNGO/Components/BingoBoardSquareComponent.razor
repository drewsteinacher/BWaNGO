@namespace BWaNGO.Components

@using BWaNGO.Models

@{
        // This has to be here to ensure the paper matches the item width
        // This only seems to affect "normal" items, since presumably the filled ones cover the paper
        const string minWidth = "min-width: 15vw;";

        <MudItem xs="2">
            <MudPaper Style="@minWidth">
                @{
                    // TODO: This probably needs redone
                    var style = "height: 13vh; text-transform: none;";

                    // For squares that are part of a winning pattern
                    if (Square.PatternIds.Count > 0)
                    {
                        style += "border: white 1px solid;";
                    }

                    style += minWidth;

                    // TODO: Could be determined via string length and/or screen size detection, the latter is harder
                    style += "font-size: 0.75rem;";

                    var winningPatterns = Board.GetWinningPatterns();
                    
                    var (variant, color) = Square switch
                    {
                        { PatternIds: { } ids, IsMarked: true }
                            when ids.Any(pid => winningPatterns.Contains(pid)) => (Variant.Filled, Color.Success),
                        { IsMarked: true } => (Variant.Filled, Color.Primary),
                        _ => (Variant.Text, Color.Surface)
                    };
                }

                <MudButton Variant="@variant"
                           Size="Size.Large"
                           FullWidth="true"
                           Style="@style"
                           Color="@color"
                           OnClick="OnClicked">
                    <MudText Typo="Typo.caption">@Square.Label</MudText>
                </MudButton>
            </MudPaper>
        </MudItem>
}

@code {
    [Parameter]
    public required BingoSquare Square { get; set; }
    
    [Parameter]
    public EventCallback<BingoSquare> SquareChanged { get; set; }

    [Parameter]
    public required BingoBoard Board { get; set; }
    
    [Parameter]
    public EventCallback<BingoBoard> BoardChanged { get; set; }

    [Parameter]
    public int Index { get; set; }

    private void OnClicked()
    {
        Console.WriteLine("Square clicked: " + Index);
        if (Square.IsMarked)
        {
            Square.UnMark();
        }
        else
        {
            Square.Mark();
        }
        // Board.GetWinningPatterns();
        StateHasChanged();
        BoardChanged.InvokeAsync(Board);
    }

}