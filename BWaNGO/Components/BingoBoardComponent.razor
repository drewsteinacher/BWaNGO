@namespace BWaNGO.Components

@using BWaNGO.Models

<MudGrid Justify="Justify.SpaceBetween" Spacing="3">
    @{
        var winningPatterns = Board.GetWinningPatterns();
        @foreach (var index in Enumerable.Range(0, Board.Rows * Board.Columns))
        {
            var square = Board.GetSquare(index % Board.Rows, index / Board.Rows);

            // This has to be here to ensure the paper matches the item width
            // This only seems to affect "normal" items, since presumably the filled ones cover the paper
            const string minWidth = "min-width: 15vw;";

            <MudItem xs="2">
                <MudPaper Style="@minWidth">
                    @{
                        // TODO: This probably needs redone
                        var style = "height: 13vh; text-transform: none;";

                        // For squares that are part of a winning pattern
                        if (square.PatternIds.Count > 0)
                        {
                            style += "border: white 1px solid;";
                        }

                        style += minWidth;

                        // TODO: Could be determined via string length and/or screen size detection, the latter is harder
                        style += "font-size: 0.75rem;";

                        var (variant, color) = square switch
                        {
                            { PatternIds: { } ids, IsMarked: true }
                                when ids.Any(pid => winningPatterns.Contains(pid))
                                => (Variant.Filled, Color.Success),
                            { IsMarked: true } => (Variant.Filled, Color.Primary),
                            _ => (Variant.Text, Color.Surface)
                        };
                    }

                    <MudButton Variant="@variant"
                               Size="Size.Large"
                               FullWidth="true"
                               Style="@style"
                               Color="@color"
                               OnClick="() => OnClicked(square)">
                        <MudText Typo="Typo.caption">@square.Label</MudText>
                    </MudButton>
                </MudPaper>
            </MudItem>

            @if ((index + 1) % Board.Rows == 0)
            {
                <MudFlexBreak/>
            }
        }
    }
</MudGrid>

@code {
    [Parameter]
    public required BingoBoard Board { get; set; }
    
    [Parameter]
    public EventCallback<BingoBoard> BoardChanged { get; set; }

    [Parameter]
    public bool IsEditMode { get; set; }

    private void OnClicked(BingoSquare square)
    {
        if (square.IsMarked)
        {
            square.UnMark();
        }
        else
        {
            square.Mark();
        }

        StateHasChanged();
        BoardChanged.InvokeAsync(Board);
    }

}