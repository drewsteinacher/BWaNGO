@inject IJSRuntime JsRuntime
@inject NavigationManager NavigationManager
@inject ClipboardService ClipboardService
@inject ILabelsRepository LabelsRepository
@inject IShareService ShareService

@page "/labels"
@using BWaNGO.Repositories
@using BWaNGO.Services

<NavigationLock ConfirmExternalNavigation="@CanSaveLabels()"
                OnBeforeInternalNavigation="UnsavedChangesDialog"/>

<PageTitle>Labels</PageTitle>

<MudText Typo="Typo.h5">Labels</MudText>
<br/>

<MudText Typo="Typo.body1">Enter custom bingo square labels here, one per line.</MudText>
<MudText Typo="Typo.body1">American Bingo is usually played with 75 numbers, but cards hold 24 each (the center space is
    free).
</MudText>
<MudText Typo="Typo.body1">If you do not enter at least 24 labels, the remaining squares will be filled by sampling.
</MudText>

<br/>

<!-- TODO: Style this so that it fills the entire vertical space available -->
<MudTextField T="string"
              Label="@_inputLabel"
              Variant="Variant.Filled"
              Lines="25"
              AutoGrow="false"
              @bind-Value="@_currentRawLabelText"
              Immediate="true"
              FullWidth="true"
              ShrinkLabel="true"
              Adornment="!CanSaveLabels() ? Adornment.End : Adornment.None"
              AdornmentIcon="@_shareIcon"
              AdornmentColor="@_shareColor"
              OnAdornmentClick="ShareLabels"
/>

<MudText Typo="Typo.body1" Color="CanSaveLabels() ? Color.Default : Color.Success">
    @Repositories.LabelsRepository.ParseLabels(_currentRawLabelText).Count Labels @(CanSaveLabels() ? "Unsaved" : "Saved")
</MudText>

<MudButton Variant="Variant.Outlined"
           Color="Color.Warning"
           Disabled="!CanSaveLabels()"
           OnClick="@ReadLabels">
    Reset
</MudButton>
<MudButton Variant="Variant.Filled"
           Color="Color.Primary"
           Disabled="!CanSaveLabels()"
           OnClick="@SaveLabels">
    Save
</MudButton>

@code {
    const string ShareQueryParameterKey = "L";

    private string _currentRawLabelText = string.Empty;

    [SupplyParameterFromQuery(Name = "L")] private string SavedRawLabelText { get; set; } = string.Empty;

    private string _shareIcon = Icons.Material.Filled.Share;
    private Color _shareColor = Color.Surface;
    private string _inputLabel = "Labels";

    protected override async Task OnInitializedAsync()
    {
        if (!string.IsNullOrWhiteSpace(SavedRawLabelText))
        {
            try
            {
                var isConfirmed = await JsRuntime.InvokeAsync<bool>("confirm",
                    "Replace current labels with shared labels?");
                if (isConfirmed)
                {
                    SavedRawLabelText = await ShareService.DecodeLabelsPayload(SavedRawLabelText);
                    _currentRawLabelText = SavedRawLabelText;

                    ClearQueryParameters();
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine("Failed to import labels from URL: " + ex);
                await JsRuntime.InvokeAsync<bool>("alert", "Failed to import labels from URL.");
            }
        }
        
        if (string.IsNullOrWhiteSpace(_currentRawLabelText))
        {
            await ReadLabels();
        }
        
        await base.OnInitializedAsync();
    }

    private async Task ReadLabels()
    {
        
        _currentRawLabelText = await LabelsRepository.GetRaw() ?? string.Empty;
        SavedRawLabelText = _currentRawLabelText;
            
        StateHasChanged();
    }

    private void ClearQueryParameters()
    {
        var uri = new Uri(NavigationManager.Uri);
        var uriWithoutQuery = uri.GetLeftPart(UriPartial.Path);
        NavigationManager.NavigateTo(uriWithoutQuery, replace: true);
    }

    private Task SaveLabels()
    {
        SavedRawLabelText = _currentRawLabelText;
        return LabelsRepository.SaveAsync(_currentRawLabelText);
    }

    private bool CanSaveLabels()
    {
        return _currentRawLabelText != SavedRawLabelText;
    }

    private async Task UnsavedChangesDialog(LocationChangingContext context)
    {
        if (!CanSaveLabels())
        {
            return;
        }

        var isConfirmed = await JsRuntime.InvokeAsync<bool>("confirm",
            "You have unsaved changes. Are you sure you want to leave?");

        if (!isConfirmed)
        {
            context.PreventNavigation();
        }
    }

    private async Task ShareLabels(MouseEventArgs obj)
    {
        var sharePayload = await ShareService.EncodeLabelsPayload(SavedRawLabelText);
        Console.WriteLine("Encoded: " + sharePayload);
        var shareUrl = NavigationManager.GetUriWithQueryParameter(ShareQueryParameterKey, sharePayload);
        await ClipboardService.WriteTextAsync(shareUrl);
        Console.WriteLine("Share: " + shareUrl);

        (_shareIcon, _shareColor, _inputLabel) = (Icons.Material.Filled.Check, Color.Success, "Labels (URL copied to clipboard!)");
        StateHasChanged();

        await Task.Delay(TimeSpan.FromSeconds(2));

        (_shareIcon, _shareColor, _inputLabel) = (Icons.Material.Filled.Share, Color.Primary, "Labels");
        StateHasChanged();
    }
}