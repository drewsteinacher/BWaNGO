@inject IBingoBoardRepository BingoBoardRepository
@inject ILabelsRepository LabelsRepository
@inject IBingoBoardGenerator BingoBoardGenerator
@inject IJSRuntime JsRuntime

@page "/"
@using BWaNGO.Models
@using BWaNGO.Repositories
@using BWaNGO.Components
@using BWaNGO.Generation
@using BWaNGO.Generation.Presets

<PageTitle>Home</PageTitle>

@if (_board is null && _labels.Count == 0)
{
    <MudText>No labels found! Add some labels on <MudLink Href="Labels">the Labels page</MudLink>.</MudText>
    return;
}

<MudTextField T="string"
              Typo="Typo.h3"
              Variant="Variant.Text"
              @bind-Text="_board!.Name"
              DebounceInterval="250"
              OnDebounceIntervalElapsed="OnBoardChanged"
              AdornmentIcon="@Icons.Material.Filled.Refresh"
              AdornmentColor="Color.Surface"
              Adornment="Adornment.End"
              OnAdornmentClick="RegenerateBoardDialog"
              AdornmentAriaLabel="Regenerate Board"
/>


<br/>

<BingoBoardComponent
    @bind-Board="_board"
    @bind-Board:after="OnBoardChanged"
    IsEditMode="_isEditMode"
/>

@code {
    private BingoBoard? _board;
    private List<string> _labels = [];
    private bool _isEditMode = false;

    protected override async Task OnInitializedAsync()
    {
        _board = await BingoBoardRepository.Get();
        if (_board is null)
        {
            await GenerateBoard();
        }

        await base.OnInitializedAsync();
    }

    private async Task GenerateBoard()
    {
        _labels = await LabelsRepository.Get();
        _board = _labels.Count > 0
            ? BingoBoardGenerator.Generate(_labels, new StandardBingoPreset())
            : null;
    }

    private Task OnBoardChanged()
        => BingoBoardRepository.SaveAsync(_board);
    
    private async Task RegenerateBoardDialog(MouseEventArgs mouseEventArgs)
    {
        var isConfirmed = await JsRuntime.InvokeAsync<bool>("confirm", 
            "Are you sure you want to regenerate the board? The current board will be lost.");

        if (isConfirmed)
        {
            await GenerateBoard();
        }
    }
}
